<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license. -->
<!-- Followed some examples from https://github.com/OfficeDev/skype-web-sdk-simple-sample-for-SfB-online -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>PatientNet Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="app.css"><!--layout file-->
  <script src="./config.js"></script> <!-- setting file-->
  <script src="https://swx.cdn.skype.com/shared/v/1.2.15/SkypeBootstrap.min.js"></script><!--Skype Web SDK-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script><!--JQuery-->
</head>
<body>
  <div class="topnav">
	  <h1>PatientNet</h1>
  </div>
  <div id="body">
  	<div id="SigninStatus"></div>
  	<div id="conversationWindow"></div>
  	<div id="conversationContainer"></div>
	<div id="loader"</div>
  </div>  

  <script type="text/javascript">
    var apiManager = null,
    	client = null,
    	org = null,
	hostId = null,
	meetingId = null,
	contact = "Emergency Contact";

    window.onload = function() {
	console.log("URL BEFORE LOAD", window.location.href);  
	// When the page loads, log in the user to Office365 if not already logged in.
	if (!location.href.includes("access_token")) {
		/*location.assign(
		    config.loginurl+
		    '&client_id='+config.clientid+
          	    '&resource='+config.resource+
          	    '&redirect_uri='+ config.clientReplyurl
		    );*/
	}
	console.log("URL arguments:", window.location.search.substring(1));
	contact = prompt("Please enter your name", "Emergency Contact");
    };

    (function () {
      //Retrieves access token from URL fragment
      console.log("URL in retrieve access token func", window.location.href);
/*      if(location.hash) {
        var hasharr = location.hash.substr(1).split("&");
        hasharr.forEach(function(hashelem) {
          var elemarr = hashelem.split("=");
          if(elemarr[0] == "access_token") {
            console.log('Access Token: '+ elemarr[1]);
	    skypeInit(skypeLogin);
	    //skypeInit(anonymousLogin);
	  }
        }, this);
      }*/
	var argStr = window.location.search.substring(1);
	var args = argStr.split(/[=&]+/);
	org = args[1];
	hostId = args[3];
	meetingId = args[5];
      skypeInit(anonymousLogin);

      /*
      Grant app with Admin Consent
      *//*
      document.getElementById('AdminConsent').onclick= function(){
        location.assign('https://login.microsoftonline.com/common/oauth2/authorize?response_type=id_token'+
          '&client_id='+config.clientid+
          '&redirect_uri='+config.clientReplyurl+
          //'&response_mode=form_post'+ //Because it is static web page and cant' handle post method, I comment out it.
          '&nonce=samplestring'+// You can add code to defend Replay Attack with nonce property
          '&resource='+config.resource+
          '&prompt=admin_consent'
        );
      };*/

      /*
      Initializing Skype Web SDK & Conversation Control.
      On success, will login in the user to Sype as well by making a callback.
      */
      function skypeInit(_loginCallback) {
	  console.log("RUNNING SKYPE INIT");
          Skype.initialize({apiKey:config.apiKeyCC},function(api){
              apiManager = api;
              client = api.UIApplicationInstance;
	      _loginCallback();

              //Event handler: whenever app state changes, display its value
              client.signInManager.state.changed(function (state) {
		document.getElementById('SigninStatus').innerHTML = state;
              });

              //Event handler : it is handled when conversations added. ie. incoming call, outgoing call
              client.conversationsManager.conversations.added(function(conversation){

                //Event handler : Get notified when conversation control receives an incoming call
                conversation.selfParticipant.audio.state.changed(function (newValue, reason, oldValue) {
                  // 'Notified' indicates that there is an incoming call
                  if(newValue === 'Notified') {
                    var person = conversation.participants(0).person;
                    var sip = person.id();

                    if (confirm("Would you like to accept this incoming call from " + person.displayName() + "?")) {
                        setTimeout(function() {
                            var container = document.getElementById(sip);
                            if(!container){
                              container = document.createElement('div');
                              container.id = sip;
                              document.getElementById("conversationWindow").appendChild(container);

                              //render conversation control
                              var promise = apiManager.renderConversation(container,{
                                //Start outgoing call
                                modalities:['Chat'],
                                participants : [sip]
                              }).then(function(conversation){
                                console.log('Conversation rendered successfully');
                              });
                            }
                            // This accepts an incoming call with audio
                            conversation.audioService.accept();
                            // To accept an incoming call with video enabled call
                            // conversation.videoService.accept()
                        }, 0);
                    } else {
                        // Reject the incoming call
                        conversation.audioService.reject();
                    }
                  }
                });
              });
          }, function(err){
            console.log(err);
          });
      }

      function guid(){
      	function s4() {
		return Math.floor((1+ Math.random()) * 0x10000)
			.toString(16)
			.substring(1);
	}
	return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
      }

      /*
	 Anonymous sign-in.
      */
      function anonymousLogin(){
	      var url = "https://meet.lync.com/" + org + "/" + hostId + "/" + meetingId;
      $.ajax({
	      url: "https://metiobank.cloudapp.net/GetAnonTokenJob",
	      type: 'post',
	      dataType: 'text',
	      data: {
		      ApplicationSessionId: guid(),
		      AllowedOrigins: window.location.href,
		      MeetingUrl: url
	      },
	      success: function(response) {
		var res = JSON.parse(response);
      		var params = {
		      	name: contact,
			cors: true,
			root: { user: res.DiscoverUri },
			token: "Bearer " + res.Token
	        };
        	client.signInManager.signIn(params).then(function(){
          		document.getElementById('SigninStatus').innerHTML = 'Signed in as ' + client.personsAndGroupsManager.mePerson.displayName();
	  		var conversation = client.conversationsManager.conversations(0);
	  		loadChat(conversation);
			},function(error){
	  			console.log("Error signing in: " + error);
			});
	      },
	      error: function(err) {
	      	console.log("Error: " + JSON.stringify(err.body));
	      }
      });
      }

      /*
      Sign-in Skype
      */
      function skypeLogin(){
        var params =
        {
         "client_id": config.clientid,
         "origins": ["https://webdir.online.lync.com/autodiscover/autodiscoverservice.svc/root"],
         "cors": true,
         "version": config.appName+'/1.0.0',
         "redirect_uri": "/client.html"
        };

        client.signInManager.signIn(params).then(function(){
          document.getElementById('SigninStatus').innerHTML = 'Signed in as ' + client.personsAndGroupsManager.mePerson.displayName();
      	  var uri = "sip:tsaoa@patientnet2.onmicrosoft.com;gruu;opaque=app:conf:focus:id:2MJ3F24I";
	  var conversation = client.conversationsManager.getConversationByUri(uri);
	  loadChat(conversation);
        },function(error){
          console.log(error);
        });
      };

      /*
      Render conversation control on outgoing call
      */
      function loadChat(conversation){
	//TODO: Show contact list instead of auto populating this contact.
	var uris = ['sip:tsaoa@patientNet2.onmicrosoft.com'];
        var container = document.createElement('div');
        document.getElementById("conversationWindow").appendChild(container);

	//render Conversation Control in a web page.
        var promise = apiManager.renderConversation(container,{
          //Start outgoing call with chat window
          modalities:['Chat'],
          conversation: conversation
        })
	promise.then(function(conversation) {
		//Rendered successfully
		document.getElementById("loader").style.display = "none";
		conversation.chatService.start();
	}, function(error) {
		console.log("Error: " + error);
	});
    /*
	var newDiv = document.createElement('div');
	var control = document.getElementById('conversationContainer');
	control.appendChild(newDiv);

        apiManager.renderConversation(newDiv,{
          //Start outgoing call with chat window
          modalities:['Chat'],
          participants: uris
	}).then(function(conversation) {
		//Rendered successfully
		conversation.chatService.start();
	}, function(error) {
		console.log("Error: " + error);
	});
	*/

      };
    }());
  </script>
</body>
